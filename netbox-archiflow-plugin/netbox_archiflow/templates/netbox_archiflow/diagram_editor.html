{% extends 'base/layout.html' %}

{% block title %}ArchiFlow Diagram Editor{% endblock %}

{% block tabs %}
<ul class="nav nav-tabs">
    <li class="nav-item">
        <a class="nav-link active" href="#">
            <i class="mdi mdi-draw"></i> Diagram Editor
        </a>
    </li>
</ul>
{% endblock tabs %}

{% block content %}
<style>
    .diagram-container {
        width: 100%;
        height: calc(100vh - 200px);
        border: 1px solid #dee2e6;
        border-radius: 4px;
        overflow: hidden;
        position: relative;
    }
    #drawio-frame {
        width: 100%;
        height: 100%;
        border: none;
    }
    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255, 255, 255, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    .loading-overlay.hidden {
        display: none;
    }
</style>

<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body p-0">
                <div class="diagram-container">
                    <div id="loading" class="loading-overlay">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="sr-only">Loading...</span>
                            </div>
                            <p class="mt-2">Loading ArchiFlow Diagram Editor...</p>
                        </div>
                    </div>
                    <iframe 
                        id="drawio-frame" 
                        src="{{ drawio_url }}/?embed=1&ui=kennedy&spin=0&plugins=0&configure=1"
                        onload="onFrameLoad()">
                    </iframe>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let drawioWindow = null;
    let pluginLoaded = false;
    
    function onFrameLoad() {
        console.log('Draw.io frame loaded, injecting ArchiFlow plugin...');
        const iframe = document.getElementById('drawio-frame');
        drawioWindow = iframe.contentWindow;
        
        // Wait a bit for Draw.io to initialize
        setTimeout(() => {
            injectArchiFlowPlugin();
        }, 2000);
    }
    
    function injectArchiFlowPlugin() {
        if (!drawioWindow) return;
        
        // Load the ArchiFlow plugin script
        fetch('{{ drawio_url }}/plugins/archiflow-complete.js')
            .then(response => response.text())
            .then(scriptContent => {
                // Inject the plugin into Draw.io
                drawioWindow.eval(scriptContent);
                console.log('ArchiFlow plugin injected successfully');
                
                // Hide loading overlay
                document.getElementById('loading').classList.add('hidden');
                
                // Initialize plugin features
                setTimeout(() => {
                    if (drawioWindow.ArchiFlow) {
                        console.log('ArchiFlow plugin initialized:', drawioWindow.ArchiFlow.version);
                        setupNetBoxIntegration();
                    } else {
                        console.warn('ArchiFlow plugin not found, retrying...');
                        // Try alternative injection method
                        alternativePluginLoad();
                    }
                }, 1000);
            })
            .catch(error => {
                console.error('Failed to load ArchiFlow plugin:', error);
                alternativePluginLoad();
            });
    }
    
    function alternativePluginLoad() {
        // Try loading via script tag in iframe
        const script = drawioWindow.document.createElement('script');
        script.src = '{{ drawio_url }}/plugins/archiflow-complete.js';
        script.onload = () => {
            console.log('ArchiFlow plugin loaded via script tag');
            document.getElementById('loading').classList.add('hidden');
            setupNetBoxIntegration();
        };
        drawioWindow.document.head.appendChild(script);
    }
    
    function setupNetBoxIntegration() {
        // Connect to WebSocket for real-time features
        const ws = new WebSocket('{{ websocket_url }}');
        
        ws.onopen = () => {
            console.log('Connected to ArchiFlow backend');
            ws.send(JSON.stringify({
                action: 'init',
                source: 'netbox',
                user: '{{ user.username }}'
            }));
        };
        
        ws.onmessage = (event) => {
            const data = JSON.parse(event.data);
            // Forward to Draw.io
            drawioWindow.postMessage(data, '*');
        };
        
        // Listen for messages from Draw.io
        window.addEventListener('message', (event) => {
            if (event.origin !== '{{ drawio_url }}') return;
            
            // Handle messages from Draw.io/ArchiFlow plugin
            if (event.data.action === 'import_devices') {
                fetchNetBoxDevices();
            } else if (event.data.action === 'allocate_ip') {
                allocateIPFromNetBox(event.data);
            } else if (ws && ws.readyState === WebSocket.OPEN) {
                // Forward to backend
                ws.send(JSON.stringify(event.data));
            }
        });
    }
    
    function fetchNetBoxDevices() {
        // Fetch devices from NetBox API
        fetch('/api/dcim/devices/', {
            headers: {
                'Accept': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            }
        })
        .then(response => response.json())
        .then(data => {
            // Send devices to Draw.io
            drawioWindow.postMessage({
                action: 'devices_loaded',
                devices: data.results
            }, '*');
        });
    }
    
    function allocateIPFromNetBox(request) {
        // This would allocate IP from NetBox IPAM
        fetch('/api/ipam/ip-addresses/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                address: request.subnet,
                description: 'Allocated by ArchiFlow'
            })
        })
        .then(response => response.json())
        .then(data => {
            drawioWindow.postMessage({
                action: 'ip_allocated',
                ip: data.address
            }, '*');
        });
    }
</script>
{% endblock %}